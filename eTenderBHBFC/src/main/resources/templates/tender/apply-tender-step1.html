<form th:action="@{/bidder/apply-tender-step1}" th:object="${tenderBid}" method="post">

    <!-- Bidder Information (View Only, Compact) -->
    <div class="card mb-3">
        <div class="card-header bg-light py-2"><h5 class="mb-0">আবেদনকারীর তথ্য</h5></div>
        <div class="card-body py-2">
            <div class="row g-2">
                <div class="col-6 col-md-4"><strong>নাম:</strong> [[${tenderBid.user.name}]]</div>
                <div class="col-6 col-md-4"><strong>ইমেইল:</strong> [[${tenderBid.user.username}]]</div>
                <div class="col-6 col-md-4"><strong>মোবাইল নাম্বার:</strong> [[${tenderBid.user.phone}]]</div>

                <div class="col-6 col-md-4"><strong>পিতা/স্বামী:</strong> [[${tenderBid.user.fatherOrSpouseName}]]</div>
                <div class="col-6 col-md-4"><strong>জাতীয়তা:</strong> [[${tenderBid.user.nationality}]]</div>
                <div class="col-6 col-md-4"><strong>ধর্ম:</strong> [[${tenderBid.user.religion}]]</div>

                <div class="col-6 col-md-6"><strong>বর্তমান ঠিকানা:</strong> [[${tenderBid.user.presentAddress}]]</div>
                <div class="col-6 col-md-6"><strong>স্থায়ী ঠিকানা:</strong> [[${tenderBid.user.permanentAddress}]]</div>

                <div class="col-6 col-md-4"><strong>জাতীয় পরিচয়পত্র (NID) নম্বর:</strong> [[${tenderBid.user.nidNumber}]]</div>
                <div class="col-6 col-md-4"><strong>ব্যবসার নাম:</strong> [[${tenderBid.user.businessName}]]</div>
                <div class="col-6 col-md-4"><strong>ব্যবসার ধরন:</strong> [[${tenderBid.user.businessType}]]</div>

                <div class="col-6 col-md-4"><strong>ট্রেড লাইসেন্স নম্বর:</strong> [[${tenderBid.user.tradeLicenseNo}]]</div>
                <div class="col-6 col-md-4"><strong>লাইসেন্স নবায়নের তারিখ:</strong> [[${tenderBid.user.tradeLicenseRenewalDate}]]</div>
                <div class="col-6 col-md-4"><strong>টিন (TIN) নম্বর:</strong> [[${tenderBid.user.tinNumber}]]</div>
            </div>
        </div>
    </div>

    <!-- Shop Selection -->
    <div class="card mb-3">
        <div class="card-header bg-light py-2 d-flex justify-content-between align-items-center">
            <h5 class="mb-0">দোকান/অফিস নির্বাচন</h5>
            <div>
                <span class="badge bg-info me-1">ন্যূনতম ১টি দোকান নির্বাচন করুন </span>
                <span class="badge bg-primary">সর্বোচ্চ ২টি দোকান নির্বাচন করুন </span>
            </div>
        </div>
        <div class="card-body py-2">
            <div class="table-responsive">
                <table class="table table-bordered table-hover table-sm align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center" style="width:50px;">নির্বাচন</th>
                            <th>দোকান</th>
                            <th>অবস্থান</th>
                            <th>মেইন ফ্লোর (বর্গফুট)</th>
                            <th>মেজানিন  ফ্লোর (বর্গফুট)</th>
                            <th>মোট আয়তন (বর্গফুট)</th>
                            <th style="width:220px">প্রস্তাবিত ভাড়া ও জামানত </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="shop : ${shops}" data-shop-number="[[${shop.number}]]">
                            <td class="text-center">
                                <input type="checkbox" class="form-check-input shop-checkbox" name="selectedShopNumbers" th:value="${shop.number}">
                            </td>
                            <td>Shop [[${shop.number}]]</td>
                            <td>[[${shop.location}]]</td>
                            <td>[[${shop.areaMainFloor}]]</td>
                            <td>[[${shop.areaMezzanineFloor}]]</td>
                            <td class="text-primary fw-bold">[[${shop.areaMainFloor + shop.areaMezzanineFloor}]]</td>
                            <td>
                                <div class="shop-inputs d-none p-2 bg-light border border-warning rounded">
                                    <div class="input-group input-group-sm mb-1">
                                        <span class="input-group-text bg-warning text-dark">ভাড়া</span>
                                        <input type="number" class="form-control rent-input" step="0.01" min="0" placeholder="প্রতি sqft" data-shop-number="[[${shop.number}]]">
                                    </div>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text bg-warning text-dark">জামানত</span>
                                        <input type="number" class="form-control security-input" step="0.01" min="0" placeholder="সিকিউরিটি" data-shop-number="[[${shop.number}]]">
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Hidden Inputs for Controller -->
        <div id="hidden-inputs"></div>

        <!-- Footer -->
        <div class="card-footer bg-light py-2 d-flex justify-content-between align-items-center">
            <div>
                <span class="badge bg-info rounded-pill p-1"><i class="bi bi-check-circle me-1"></i><span id="selection-count">0</span> দোকান</span>
                <span id="min-alert" class="ms-2 text-danger d-none"><i class="bi bi-exclamation-triangle"></i> ন্যূনতম ১টি নির্বাচন করুন</span>
                <span id="max-alert" class="ms-2 text-warning d-none"><i class="bi bi-exclamation-circle"></i> সর্বোচ্চ ২টি দোকান</span>
                <span id="valid-selection" class="ms-2 text-success d-none"><i class="bi bi-check-circle"></i> ঠিক আছে</span>
            </div>
            <button type="submit" class="btn btn-primary btn-sm px-3" id="submit-btn" disabled>
                <i class="bi bi-arrow-right"></i> পরবর্তী
            </button>
        </div>
    </div>

    <!-- Max Selection Modal -->
    <div class="modal fade" id="maxSelectionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h6 class="modal-title"><i class="bi bi-exclamation-triangle-fill me-1"></i>সর্বোচ্চ সীমা পূর্ণ</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-0">আপনি সর্বোচ্চ <strong>২টি দোকান</strong> নির্বাচন করতে পারেন।<br>আরেকটি নির্বাচন করার আগে একটি আন-সিলেক্ট করুন।</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">ঠিক আছে</button>
                </div>
            </div>
        </div>
    </div>

</form>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const checkboxes = document.querySelectorAll('.shop-checkbox');
    const counter = document.getElementById('selection-count');
    const submitBtn = document.getElementById('submit-btn');
    const minAlert = document.getElementById('min-alert');
    const maxAlert = document.getElementById('max-alert');
    const validAlert = document.getElementById('valid-selection');
    const hiddenInputsContainer = document.getElementById('hidden-inputs');

    function updateHiddenInputs() {
        hiddenInputsContainer.innerHTML = '';
        document.querySelectorAll('.shop-checkbox:checked').forEach(cb => {
            const row = cb.closest('tr');
            const shopNumber = cb.value;
            const rent = row.querySelector('.rent-input').value || '0';
            const security = row.querySelector('.security-input').value || '0';
            hiddenInputsContainer.innerHTML += `
                <input type="hidden" name="shopNumbers" value="${shopNumber}">
                <input type="hidden" name="rentAmounts" value="${rent}">
                <input type="hidden" name="securityAmounts" value="${security}">
            `;
        });
    }

    function updateSelection() {
        const checked = document.querySelectorAll('.shop-checkbox:checked');
        const count = checked.length;

        counter.textContent = count;
        minAlert.classList.add('d-none');
        maxAlert.classList.add('d-none');
        validAlert.classList.add('d-none');

        if (count === 0) submitBtn.disabled = true, minAlert.classList.remove('d-none');
        else if (count > 2) submitBtn.disabled = true, maxAlert.classList.remove('d-none');
        else submitBtn.disabled = false, validAlert.classList.remove('d-none');

        checkboxes.forEach(cb => {
            const row = cb.closest('tr');
            const inputs = row.querySelector('.shop-inputs');
            const rent = row.querySelector('.rent-input');
            const security = row.querySelector('.security-input');

            if (cb.checked) {
                row.classList.add('table-success');
                inputs.classList.remove('d-none');
                rent.required = true;
                security.required = true;
            } else {
                row.classList.remove('table-success');
                inputs.classList.add('d-none');
                rent.required = false;
                security.required = false;
            }
        });

        if (count === 2) document.querySelectorAll('.shop-checkbox:not(:checked)').forEach(cb => cb.disabled = true);
        else document.querySelectorAll('.shop-checkbox').forEach(cb => cb.disabled = false);

        updateHiddenInputs();
    }

    checkboxes.forEach(cb => cb.addEventListener('change', function () {
        if (document.querySelectorAll('.shop-checkbox:checked').length > 2) {
            this.checked = false;
            new bootstrap.Modal(document.getElementById('maxSelectionModal')).show();
            return;
        }
        updateSelection();
    }));

    document.querySelectorAll('.rent-input, .security-input').forEach(input => {
        input.addEventListener('input', updateHiddenInputs);
    });

    updateSelection();
});
</script>

<style>
.table-sm td, .table-sm th { padding: 0.35rem; }
.table-hover tbody tr:hover { background-color: #f8f9fa; }
.table-success { background-color: #e9f7ef; font-weight: 600; }

.shop-inputs { padding: 0.25rem; background: #fff3cd; border-radius: 0.25rem; border: 1px solid #ffc107; }
#submit-btn:disabled { opacity: 0.6; cursor: not-allowed; }
</style>
